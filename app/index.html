<!--
 File: index.html.tpl
 * Copyright (c) 2013-2016
 * Centre National d’Enseignement à Distance (Cned), Boulevard Nicephore Niepce, 86360 CHASSENEUIL-DU-POITOU, France
 * (direction-innovation@cned.fr)
 *
 * GNU Affero General Public License (AGPL) version 3.0 or later version
 *
 * This file is part of a program which is free software: you can
 * redistribute it and/or modify it under the terms of the
 * GNU Affero General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU Affero General Public License for more details.
 *
 * You should have received a copy of the GNU Affero General Public
 * License along with this program.
 * If not, see <http://www.gnu.org/licenses/>.
 -->

<!doctype html>
<!--[if lt IE 7]>
<html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>
<html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>
<html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js" lang="fr" manifest="index.appcache"> <!--<![endif]-->
<head>
    <meta name="utf8beacon" content="éçñøåá—"/>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title></title>
    <meta name="description" content="">
    <meta name="viewport" content="width=1160">

    <meta property="og:title" content="Un élément a été partagé via l'outil Accessidys"/>
    <meta property="og:description"
          content="Accessidys est un outil proposé par le CNED - Mentions légales - ©2014 CNED"/>
    <meta property="og:site_name" content="www.accessidys.org"/>
    <meta property="og:type" content="website">

    <!-- bower:css -->
    <link rel="stylesheet" href="bower_components/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="bower_components/components-font-awesome/css/font-awesome.css" />
    <!-- endbower -->

    <!-- Place favicon.ico and apple-touch-icon.png in the root directory -->
    <link rel="stylesheet" href="styles/treeView.min.css">
    <link rel="stylesheet" href="styles/animate.min.css">
    <link rel="stylesheet" href="styles/step.min.css">
    <link rel="stylesheet" href="styles/main.min.css">
    <link rel="stylesheet" href="styles/styles.min.css">


</head>
<body key-trap class="body-home" data-ng-app="cnedApp" history-browser="" data-ng-class="{'pt-105': isFullsize}">

<div id="fb-root"></div>
<script>
    (function (d, s, id) {
        var js, fjs = d.getElementsByTagName(s)[0];
        if (d.getElementById(id)) return;
        js = d.createElement(s);
        js.id = id;
        js.src = "//connect.facebook.net/en_US/sdk.js#xfbml=1&appId=657960714228766&version=v2.0";
        fjs.parentNode.insertBefore(js, fjs);
    }(document, 'script', 'facebook-jssdk'));

    window.fbAsyncInit = function () {
        FB.init({
            xfbml: false  // Will stop the fb like button from rendering automatically
        });
    };
</script>

<script type="text/javascript">
    (function () {
        var po = document.createElement('script');
        po.type = 'text/javascript';
        po.async = true;
        po.src = 'https://apis.google.com/js/client:plusone.js';
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(po, s);
    })();
</script>

<!--[if lt IE 7]>
<![endif]-->
<!--[if lt IE 9]>
<![endif]-->
<!-- Add your site or application content here -->
<div ng-include="'views/common/header.html'" data-ng-show="!apercu || isGuest" class="header_zone"
     id="main_header"></div>

<div class="container" data-ng-view></div>

<!-- Footer -->
<div data-ng-include="'views/common/footer.html'"></div>
<!-- End Footer -->
<div class="no-show">A</div>
<div data-ng-show='indexLoader' class="loader_cover">
    <div id="loader_container">
        <div class="loader_bar">
            <div class="progress_bar" style="width:{{loaderProgress}}%;">&nbsp;
            </div>
        </div>
        <p class="hide_if_emergency loader_txt">{{loaderMessage}} <img src="styles/images/loader_points.gif"
                                                                       alt="loader"/></p>
        <p class="emergency_message loader_txt">Une version plus récente de l'application a été détectée. Mise à jour de
            votre document en cours . Veuillez patienter <img src="styles/images/loader_points.gif" alt="loader"/></p>
    </div>
</div>
<div class="fixed_loader" id="upgradeLoader" style="display:none;">
    <div class="loadre_container">
        <p class="loader_txt"
        >Une version plus récente de l'application a été détectée. Mise à jour de votre document en
            cours . Veuillez patienter .<img src="styles/images/loader_points.gif" alt="loader"/></p>
    </div>
</div>




<div data-appcache-updated></div>

<!-- bower:js -->
<script src="bower_components/jquery/dist/jquery.js"></script>
<script src="bower_components/angular/angular.js"></script>
<script src="bower_components/angular-animate/angular-animate.js"></script>
<script src="bower_components/angular-sanitize/angular-sanitize.js"></script>
<script src="bower_components/angular-cookies/angular-cookies.js"></script>
<script src="bower_components/angular-resource/angular-resource.js"></script>
<script src="bower_components/angular-route/angular-route.js"></script>
<script src="bower_components/angular-gettext/dist/angular-gettext.js"></script>
<script src="bower_components/angular-audio/app/angular.audio.js"></script>
<script src="bower_components/angular-bootstrap/ui-bootstrap-tpls.js"></script>
<script src="bower_components/underscore/underscore.js"></script>
<script src="bower_components/rangy/rangy-core.js"></script>
<script src="bower_components/rangy/rangy-classapplier.js"></script>
<script src="bower_components/rangy/rangy-highlighter.js"></script>
<script src="bower_components/rangy/rangy-selectionsaverestore.js"></script>
<script src="bower_components/rangy/rangy-serializer.js"></script>
<script src="bower_components/rangy/rangy-textrange.js"></script>
<script src="bower_components/angular-google-analytics/dist/angular-google-analytics.min.js"></script>
<script src="bower_components/localforage/dist/localforage.js"></script>
<script src="bower_components/angular-localforage/dist/angular-localForage.js"></script>
<script src="bower_components/angular-md5/angular-md5.js"></script>
<script src="bower_components/Hyphenator/Hyphenator.js"></script>
<script src="bower_components/jszip/dist/jszip.js"></script>
<script src="bower_components/pdfjs-dist/build/pdf.js"></script>
<script src="bower_components/pdfjs-dist/build/pdf.worker.js"></script>
<!-- endbower -->

<script src="external_components/ckeditor/ckeditor.js"></script>

<script type="text/javascript">
    var memoryInitializer = "external_components/tesseractJS/TesseractJS.mem";
</script>
<script async src="external_components/tesseractJS/TesseractJS.js"></script>


<script src="scripts/services/config.js"></script>
<!-- build:js({.tmp,app}) scripts/front.js -->
<script src="viewsScripts/template_cache.js"></script>
<script src="scripts/app.js"></script>
<script src="scripts/translations.js"></script>
<script src="scripts/services/helpers.js"></script>
<script src="scripts/services/htmlEpubConverter.js"></script>
<script src="scripts/services/tagsService.js"></script>
<script src="scripts/services/fileStorageService.js"></script>
<script src="scripts/services/profilsService.js"></script>
<script src="scripts/services/workspaceService.js"></script>
<script src="scripts/services/speechService.js"></script>
<script src="scripts/services/keyboardSelectionService.js"></script>
<script src="scripts/services/synchronisationService.js"></script>
<script src="scripts/services/synchronisationStoreService.js"></script>
<script src="scripts/controllers/index/main.js"></script>
<script src="scripts/controllers/common/common.js"></script>
<script src="scripts/controllers/common/information.modal.js"></script>
<script src="scripts/controllers/tag/tag.js"></script>
<script src="scripts/controllers/workspace/apercu.js"></script>
<script src="scripts/controllers/workspace/listDocumentModal.js"></script>
<script src="scripts/controllers/workspace/print.js"></script>
<script src="scripts/controllers/profiles/profiles.js"></script>
<script src="scripts/controllers/passport/passport.js"></script>
<script src="scripts/controllers/passport/passportContinue.js"></script>
<script src="scripts/controllers/userAccount/userAccount.js"></script>
<script src="scripts/controllers/adminPanel/adminPanel.js"></script>
<script src="scripts/controllers/listDocument/listDocument.js"></script>
<script src="scripts/controllers/addDocument/addDocument.js"></script>
<script src="scripts/controllers/passwordRestore/passwordRestore.js"></script>
<script src="scripts/controllers/404/404.js"></script>
<script src="scripts/controllers/needUpdate/needUpdate.js"></script>
<script src="scripts/controllers/synchronisation/synchronisationModal.js"></script>
<script src="scripts/directives/bodyClasses.js"></script>
<script src="scripts/directives/regleStyle.js"></script>
<script src="scripts/directives/sselect.js"></script>
<script src="scripts/directives/documentMethodes.js"></script>
<script src="scripts/directives/uploadFile.js"></script>
<script src="scripts/controllers/profiles/detailProfilModal.js"></script>
<script src="scripts/controllers/profiles/editProfilModal.js"></script>
<script src="scripts/controllers/profiles/renameProfilModal.js"></script>
<script src="scripts/controllers/infoPages/vocalHelpModal.js"></script>
<script src="scripts/controllers/addDocument/edit-document-title.modal.js"></script>
<script src="scripts/services/documentService.js"></script>
<script src="scripts/services/loader.service.js"></script>
<script src="scripts/services/utils.service.js"></script>
<script src="scripts/services/email.service.js"></script>
<script src="scripts/controllers/social-share/social-share.modal.js"></script>
<script src="scripts/controllers/common/confirm.modal.js"></script>
<!-- endbuild -->

<script type="text/javascript">

    function AppcacheUpdated() {
        console.log('AppcacheUpdated');
        var elementScope;
        var fileCounter = 0;
        console.log('window.applicationCache.status');
        console.log(window.applicationCache.status);

        return {
            restrict: 'EA',
            scope: {},
            link: function (scope) {
                elementScope = scope;
            },
            controller: function ($scope, $rootScope, $timeout, $location) {

                var appCache = window.applicationCache;
                console.log(window.applicationCache.status);
                $rootScope.indexLoader = false;
                $rootScope.emergencyUpgrade = false;
                $rootScope.loaderMessage = '';
                appCache.addEventListener('cached', function (e) {
                    console.log('window.applicationCache.addEventListener cached');
                    console.log(e);
                    console.log(window.applicationCache.status);
                    console.log('timeout');
                    var tmp = window.location.href;
                    if (tmp.indexOf("adaptation.html") > 0 && tmp.indexOf("/listDocument") > 0) {
                        $rootScope.loaderMessage = 'Vérification de vos documents. Veuillez patienter ';
                    } else {
                        if (tmp.indexOf("/workspace") > 0) {
                            $rootScope.$broadcast('showFileDownloadLoader');
                        }
                        if ($rootScope.emergencyUpgrade == false) {
                            $rootScope.indexLoader = false;
                            if (!$rootScope.$$phase) {
                                $rootScope.$digest();
                            }
                        }
                        if (!$rootScope.$$phase) {
                            $rootScope.$digest();
                        }
                    }
                    $timeout(function () {
                        $rootScope.$broadcast('RefreshListDocument');
                        $rootScope.$broadcast('UpgradeProcess');
                        $scope.show = false;
                    });
                });

                appCache.addEventListener('updateready', function (e) {
                    console.log('Update Ready ==> updateready 1 ... ');
                    //window.location.reload();
                    localStorage.setItem('appcacheUpdated', true);
                    if (localStorage.getItem('appCheck') != null) {
                        localStorage.removeItem('appcacheUpdated');
                        localStorage.removeItem('appCheck');

                        setTimeout(function () {
                            window.location.reload()
                        }, 2000)
                    }
                });

                appCache.addEventListener('downloading', function (event) {
                    console.log("Started Download.");
                    $rootScope.indexLoader = true;
                    $('.loader_cover').show();
                    if (!$rootScope.$$phase) {
                        $rootScope.$digest();
                    }
                }, false);

                appCache.addEventListener('progress', function (event) {
                    $rootScope.indexLoader = true;
                    $('.loader_cover').show();
                    console.log('_________Progress______________');
                    if (!event.loaded || !event.total) {
                        fileCounter++;
                        event.loaded = fileCounter;
                        event.total = 128;
                    }
                    console.log(event.loaded + " of " + event.total);
                    if (event.loaded === event.total) {
                        $rootScope.loaderMessage = '';
                        if (!$rootScope.$$phase) {
                            $rootScope.$digest();
                        }

                    } else {
                        var tmp = window.location.href;
                        if (tmp.indexOf("#/listDocument") > -1) {
                            $rootScope.loaderMessage = 'Chargement de la liste de vos documents en cours. Veuillez patienter ';
                        } else {
                            var urlMatch = /((\d+)(-)(\d+)(-)(\d+))/i.exec(encodeURIComponent(tmp));
                            if (urlMatch && urlMatch.length > 0) {
                                $rootScope.loaderMessage = 'Mise en cache de votre document en cours. Veuillez patienter ';
                            } else {
                                $rootScope.loaderMessage = 'Mise en cache de l\'application en cours. Veuillez patienter ';
                            }
                        }
                        $rootScope.loaderProgress = parseInt((event.loaded * 100) / event.total);
                        $rootScope.indexLoader = true;
                        if (!$rootScope.$$phase) {
                            $rootScope.$digest();
                        }
                    }

                }, false);

                appCache.addEventListener('noupdate', function (event) {
                    console.log('noupdate event');
                    var tmp = window.location.href;
                    if (tmp.indexOf("adaptation.html" && tmp.indexOf("/listDocument") > 0) > 0) {
                        $rootScope.loaderMessage = 'Vérification de vos documents en cours.Veuillez patienter ';
                    } else {
                        if (tmp.indexOf("/workspace") > 0) {
                            $rootScope.$broadcast('showFileDownloadLoader');
                        }
                        if ($rootScope.emergencyUpgrade == false) {
                            $rootScope.indexLoader = false;
                            if (!$rootScope.$$phase) {
                                $rootScope.$digest();
                            }
                        }
                        if (!$rootScope.$$phase) {
                            $rootScope.$digest();
                        }
                    }
                    $timeout(function () {
                        $rootScope.$broadcast('RefreshListDocument');
                        $rootScope.$broadcast('UpgradeProcess');

                        $scope.show = false;
                    }, 500, true);
                }, false);


                appCache.addEventListener('checking', function (event) {
                    console.log('noupdate event + affiche Loader ici');
                    $rootScope.indexLoader = true;
                }, false);

                if (!navigator.onLine) {
                    console.log('you are really offline');
                    $scope.show = true;
                }
                if (window.applicationCache.status === 4) {
                    console.log('Update Ready ==> updateready 2 ... ');
                    //window.location.reload();
                    localStorage.setItem('appcacheUpdated', true);
                    if (localStorage.getItem('appCheck') != null) {
                        localStorage.removeItem('appcacheUpdated');
                        localStorage.removeItem('appCheck');

                        setTimeout(function () {
                            window.location.reload()
                        }, 2000)
                    }
                }
                if (window.applicationCache.status === 1) {
                    console.log('window.applicationCache.addEventListener noupdate');
                    console.log(window.applicationCache.status);
                    $scope.show = true;

                }
                $scope.$watch("show", function (value) {
                    console.log('show ==> ' + value);
                    if (value === true && ($location.absUrl().indexOf('listDocument') > 0 || $location.absUrl().indexOf('apercu'))) {
                        console.log('emitting event');
                        $timeout(function () {
                            $rootScope.$broadcast('RefreshListDocument');
                            $rootScope.$broadcast('UpgradeProcess');
                            $scope.show = false;
                        });
                    }
                });
            }

        };
    }

    angularModule = angular.module('cnedApp');
    console.log('angularModule ==> ');
    console.log(angularModule);
    if (typeof PDFJS !== 'undefined') {
        PDFJS.workerSrc = 'bower_components/pdfjs/pdf.worker.min.js';
    }
    if (typeof String.prototype.endsWith != 'function') {
        String.prototype.endsWith = function (str) {
            return str.length > 0 && this.substring(this.length - str.length, this.length) === str;
        }
    }
    var finalVersion = false;
    var counter = 0;
</script>
<script>
    var ownerId = null;
</script>
</body>
</html>
